<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Realtime Voice Assistant</title>
<style>
body { font-family: sans-serif; background:#0b0e14; color:#e6edf3; display:flex; flex-direction:column; align-items:center; padding:20px; }
h1 { margin-bottom:16px; }
.card { background:#131721; padding:16px; border-radius:16px; width:90%; max-width:800px; margin-bottom:16px; }
#controls { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
button { padding:10px 16px; border:none; border-radius:12px; cursor:pointer; background:#76b3fa; color:#0a1020; font-weight:600; }
button:disabled { opacity:0.5; cursor:not-allowed; }
#output { background:#0f1320; border-radius:12px; padding:12px; min-height:200px; max-height:60vh; overflow:auto; white-space:pre-wrap; font-family:monospace; }
.partial { color:#96a0b5; opacity:0.8; }
.final { color:#e6edf3; opacity:0.95; }
</style>
</head>
<body>

<h1>Realtime Voice Assistant</h1>

<div class="card" id="controls">
  <button id="startBtn">Start Listening</button>
  <button id="stopBtn" disabled>Stop</button>
  <label>Language:
    <select id="language">
      <option value="en-US">English</option>
      <option value="hi-IN">Hindi</option>
    </select>
  </label>
</div>

<div class="card">
  <div id="output">
    <span class="final" id="finalText"></span>
    <span class="partial" id="partialText"></span>
  </div>
</div>

<script>
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const languageSelect = document.getElementById("language");
const partialSpan = document.getElementById("partialText");
const finalSpan = document.getElementById("finalText");

let recognition;
let ttsAudio = null;

// ----------- STT -----------
function startRecognition() {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = languageSelect.value;

  recognition.onresult = async (event) => {
    let partial = "";
    let finalTranscript = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      if(res.isFinal) finalTranscript += res[0].transcript + " ";
      else partial += res[0].transcript + " ";
    }
    partialSpan.textContent = partial;
    if(finalTranscript) {
      finalSpan.textContent += finalTranscript;
      partialSpan.textContent = "";

      // Stop TTS immediately if user starts talking (VAD)
      if(ttsAudio && !ttsAudio.paused) {
        ttsAudio.pause();
        ttsAudio.currentTime = 0;
      }

      // Send to backend for intent
      const resp = await fetch(`https://com-cloud.cloud/determine_intent`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: finalTranscript.trim() })
      });
      const data = await resp.json();
      if(data.result) playTTS(data.result);
    }
  };

  recognition.onstart = () => startBtn.textContent = "Listening...";
  recognition.onend = () => startBtn.textContent = "Start Listening";
  recognition.onerror = (e) => console.error("STT error:", e);

  recognition.start();
}

function stopRecognition() {
  if(recognition) recognition.stop();
}

// ----------- TTS -----------
function playTTS(text) {
  if(ttsAudio) {
    ttsAudio.pause();
    ttsAudio.currentTime = 0;
  }
  ttsAudio = new Audio(`https://com-cloud.cloud/tts?text=${encodeURIComponent(text)}&voice=nova`);
  ttsAudio.play();
}

// ----------- UI -----------
startBtn.addEventListener("click", () => {
  startBtn.disabled = true;
  stopBtn.disabled = false;
  startRecognition();
});

stopBtn.addEventListener("click", () => {
  startBtn.disabled = false;
  stopBtn.disabled = true;
  stopRecognition();
  if(ttsAudio) {
    ttsAudio.pause();
    ttsAudio.currentTime = 0;
  }
});

languageSelect.addEventListener("change", () => {
  if(recognition) recognition.lang = languageSelect.value;
});
</script>

</body>
</html>
