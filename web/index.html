<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Browser Voice Assistant</title>
</head>
<body>
<h1>Browser Voice Assistant</h1>
<button id="startBtn">Start Listening</button>
<p id="transcript"></p>
<p id="response"></p>

<script>
let recognition;
let isListening = false;
let currentUtterance = null;

// --------------------
// Speech Recognition Setup
// --------------------
if (!('webkitSpeechRecognition' in window)) {
    alert("Browser does not support SpeechRecognition API");
} else {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onresult = (event) => {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        document.getElementById('transcript').innerText = transcript;

        // When final speech is detected
        if (event.results[event.results.length - 1].isFinal) {
            stopTTS(); // make sure TTS is cut immediately

            // Small delay to avoid overlap
            setTimeout(() => {
                sendToServer(transcript);
            }, 150);
        }
    };

    recognition.onend = () => {
        if (isListening) recognition.start(); // auto-restart
    };
}

document.getElementById('startBtn').addEventListener('click', () => {
    if (!isListening) {
        recognition.start();
        isListening = true;
    } else {
        recognition.stop();
        isListening = false;
    }
});

// --------------------
// TTS functions
// --------------------
function playTTS(text) {
    stopTTS(); // ensure no overlap
    currentUtterance = new SpeechSynthesisUtterance(text);
    window.speechSynthesis.speak(currentUtterance);
}

function stopTTS() {
    if (speechSynthesis.speaking || speechSynthesis.pending) {
        window.speechSynthesis.cancel(); // force stop
    }
    currentUtterance = null;
}

// --------------------
// Send transcript to FastAPI
// --------------------
async function sendToServer(text) {
    try {
        const resp = await fetch("https://com-cloud.cloud/api/determine_intent", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message: text})
        });
        const data = await resp.json();
        document.getElementById('response').innerText = data.result;
        playTTS(data.result);
    } catch (err) {
        console.error("Error sending to server:", err);
    }
}
</script>
</body>
</html>
