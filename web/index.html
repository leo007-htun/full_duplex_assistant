<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Browser Voice Assistant</title>
</head>
<body>
<h1>Browser Voice Assistant</h1>
<button id="startBtn">Start Listening</button>
<p id="transcript"></p>
<p id="response"></p>

<script>
let recognition;
let isListening = false;
let currentUtterance = null;

// Check for browser STT support
if (!('webkitSpeechRecognition' in window)) {
    alert("Browser does not support SpeechRecognition API");
} else {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onresult = (event) => {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        document.getElementById('transcript').innerText = transcript;

        // Detect VAD (voice is speaking) and stop TTS
        if (event.results[event.results.length-1].isFinal) {
            stopTTS();
            sendToServer(transcript);
        }
    };

    recognition.onend = () => {
        if (isListening) recognition.start(); // auto-restart
    };
}

document.getElementById('startBtn').addEventListener('click', () => {
    if (!isListening) {
        recognition.start();
        isListening = true;
    } else {
        recognition.stop();
        isListening = false;
    }
});

// --------------------
// TTS functions
// --------------------
function playTTS(text) {
    stopTTS();
    currentUtterance = new SpeechSynthesisUtterance(text);
    window.speechSynthesis.speak(currentUtterance);
}

function stopTTS() {
    if (currentUtterance) {
        window.speechSynthesis.cancel();
        currentUtterance = null;
    }
}

// --------------------
// Send transcript to FastAPI
// --------------------
async function sendToServer(text) {
    try {
        const resp = await fetch("https://com-cloud.cloud/api/determine_intent", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message: text})
        });
        const data = await resp.json();
        document.getElementById('response').innerText = data.result;
        playTTS(data.result);
    } catch (err) {
        console.error("Error sending to server:", err);
    }
}
</script>
</body>
</html>
