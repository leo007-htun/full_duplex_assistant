<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voice Assistant</title>
</head>
<body>
<button id="start">Start Listening</button>
<div id="transcript"></div>

<script>
let recognizing = false;
let recognition;
let ttsUtterance;
let speechSynthesisActive = false;

if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
} else if ('SpeechRecognition' in window) {
    recognition = new SpeechRecognition();
}

recognition.continuous = true;
recognition.interimResults = true;
recognition.lang = 'en-US';

recognition.onresult = async (event) => {
    let transcript = '';
    for (let i = event.resultIndex; i < event.results.length; ++i) {
        transcript += event.results[i][0].transcript;
    }
    document.getElementById('transcript').innerText = transcript;

    if (event.results[event.results.length-1].isFinal) {
        // Stop ongoing TTS if user starts talking
        if (speechSynthesisActive) {
            window.speechSynthesis.cancel();
            speechSynthesisActive = false;
        }

        // Send to FastAPI
        const res = await fetch('/api/determine_intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: transcript })
        });
        const data = await res.json();
        speak(data.result);
    }
};

function speak(text) {
    if (!text) return;
    ttsUtterance = new SpeechSynthesisUtterance(text);
    ttsUtterance.onstart = () => { speechSynthesisActive = true; };
    ttsUtterance.onend = () => { speechSynthesisActive = false; };
    window.speechSynthesis.speak(ttsUtterance);
}

document.getElementById('start').onclick = () => {
    if (!recognizing) {
        recognition.start();
        recognizing = true;
    } else {
        recognition.stop();
        recognizing = false;
    }
};
</script>
</body>
</html>
