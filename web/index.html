<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Browser Voice Assistant</title>
<style>
  body { font-family: sans-serif; margin: 2rem; }
  #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 1rem; height: 300px; overflow-y: auto; }
  button { margin-right: 1rem; }
</style>
</head>
<body>

<h1>Voice Assistant</h1>
<button id="startBtn">Start Listening</button>
<button id="stopBtn">Stop Listening</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");

function log(msg) {
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

// -------------------
// WebSocket to FastAPI
// -------------------
const ws = new WebSocket("wss://com-cloud.cloud/ws/stream");

ws.onopen = () => log("[WebSocket] Connected");
ws.onclose = () => log("[WebSocket] Disconnected");
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if(data.type === "gpt_response") {
    log(`[GPT] Intent: ${data.intent}, Response: ${data.text}`);
    speakTTS(data.text);
  }
};

// -------------------
// Web Speech Recognition
// -------------------
let recognition;
let recognizing = false;

if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = "en-US";

  recognition.onstart = () => { recognizing = true; log("[STT] Listening..."); }
  recognition.onend = () => { recognizing = false; log("[STT] Stopped"); }
  recognition.onerror = (e) => log("[STT] Error: " + e.error);

  recognition.onresult = (event) => {
    let transcript = '';
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      transcript += event.results[i][0].transcript;
    }
    if(transcript.trim()) {
      log("[STT] " + transcript);
      ws.send(JSON.stringify({ type: "user_text", text: transcript }));
    }
  };
}

// -------------------
// TTS (Interruptible)
// -------------------
let ttsUtterance;
function speakTTS(text) {
  stopTTS(); // stop previous speech
  if('speechSynthesis' in window) {
    ttsUtterance = new SpeechSynthesisUtterance(text);
    speechSynthesis.speak(ttsUtterance);
  }
}

function stopTTS() {
  if('speechSynthesis' in window) {
    speechSynthesis.cancel(); // stop immediately
  }
}

// -------------------
// Buttons
// -------------------
document.getElementById("startBtn").onclick = () => {
  if(!recognizing) recognition.start();
};
document.getElementById("stopBtn").onclick = () => {
  if(recognizing) recognition.stop();
};
</script>

</body>
</html>
